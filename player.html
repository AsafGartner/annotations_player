<html>
<head>
<meta charset="UTF-8">
<style>
body {
    font-family: sans-serif;
    background-color: #222222;
}

.titleRow {
    display: flex;
    flex-direction: horizontal;
    border: 1px solid black;
    background: grey;
    color: white;
    padding: 7px;
}

.title {
    flex-grow: 1;
}

.middleContainer {
    display: flex;
    flex-direction: horizontal;
}

.marksContainer {
    display: inline-block;
    overflow-y: scroll;
    overflow-x: hidden;
    flex-shrink: 0;
}

.marker {
    position :relative;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.marker:hover .content {
    background-color: #222;
}

.marker .content, .marker .completed {
    background-color: #161616;
    color: #8A877D;
}

.marker.current .content {
    color: #B57714;
}

.marker .content, .marker .completed {
    width: 300px;
    display: block;
    padding: 5px;
    font-size: 14px;
    cursor: pointer;
    word-wrap: break-word;
}

.marker .completed {
    background-color: #8B3D23;
    color: black;
}

.marker .progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    overflow: hidden;
}

.marker.passed {
    background: purple;
}

.videoContainer {
    flex-grow: 1;
    flex-shrink: 1;
    display: inline-block;
    overflow: hidden;
}

</style>
</head>
<body>

<div class="playerContainer">
    <div class="titleRow">
        <span class="title"></span>
        <span class="author"></span>
    </div>
    <div class="middleContainer">
        <div class="marksContainer">
        </div>
        <div class="videoContainer">
            <div id="player"></div>
        </div>
    <div>
    <div class="footer">
    </div>
</div>
<script>
var player = null;
var playing = false;
var youtubePlayerReady = false;
function onYouTubeIframeAPIReady() {
    youtubePlayerReady = true;
    initVideo();
}
</script>
<script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
<script>
// Page generation stuff (to be removed once this is rendered by the server)
var hash = location.hash;
var annotationsFileLocation = null;
if (hash && hash.length > 1 && hash[0] == "#") {
    annotationsFileLocation = hash.slice(1);
} else {
    document.write("No file specified");
}

if (annotationsFileLocation) {
    var annotations = {
        markers: []
    };

    var xhr = new XMLHttpRequest();
    xhr.addEventListener("load", function() {
        var contents = xhr.response;

        var lines = contents.split("\n");
        var mode = "none";
        for (var i = 0; i < lines.length; ++i) {
            var line = lines[i];
            if (line == "---") {
                mode = "none";
            } else if (line.startsWith("title:")) {
                annotations.title = line.slice(8).replace(/"/g, "");
            } else if (line.startsWith("videoId:")) {
                annotations.videoId = line.slice(10).replace(/"/g, "");
            } else if (line.startsWith("author:")) {
                annotations.author = line.slice(9).replace(/"/g, ""); // Miblo, where's the author field?
            } else if (line.startsWith("markers")) {
                mode = "markers";
            } else if (mode == "markers") {
                var match = line.match(/"((\d+):)?(\d+):(\d+)": "(.+)"/);
                var mark = {
                    totalTime: (match[2] ? parseInt(match[2], 10) : 0) * 60 * 60 + parseInt(match[3], 10) * 60 + parseInt(match[4], 10),
                    text: match[5].replace(/\\"/g, "\"")
                }
                annotations.markers.push(mark);
            }
        }

        generatePlayer(annotations);
    });

    xhr.addEventListener("error", function() {
        document.write("Could not load annotations file");
    });
    xhr.open("GET", annotationsFileLocation);
    xhr.setRequestHeader("Content-Type", "text/plain");
    xhr.send();
}

function generatePlayer(annotations) {
    var playerContainer = document.querySelector(".playerContainer");
    var title = playerContainer.querySelector(".title");
    var author = playerContainer.querySelector(".author");
    var marksContainer = playerContainer.querySelector(".marksContainer");

    author.textContent = "Annotations by: " + (annotations.author || "Probably Miblo");
    title.textContent = annotations.title;

    for (var i = 0; i < annotations.markers.length; ++i) {
        var marker = annotations.markers[i];
        var markerEl = document.createElement("DIV");
        var contentEl = document.createElement("DIV");
        var progressEl = document.createElement("DIV");
        var completedEl = document.createElement("DIV");
        markerEl.classList.add("marker");
        contentEl.classList.add("content");
        progressEl.classList.add("progress");
        completedEl.classList.add("completed");
        markerEl.setAttribute("data-timestamp", marker.totalTime);
        contentEl.textContent = markerTime(marker) + " " + marker.text;
        completedEl.textContent = markerTime(marker) + " " + marker.text;
        markerEl.appendChild(contentEl);
        markerEl.appendChild(progressEl);
        progressEl.appendChild(completedEl);
        marksContainer.appendChild(markerEl);
    }

    initVideo();
}

function markerTime(marker) {
    var markTime = "(";
    var hours = Math.floor(marker.totalTime / 60 / 60);
    var minutes = Math.floor(marker.totalTime / 60) % 60;
    var seconds = marker.totalTime % 60;
    if (hours > 0) {
        markTime += padTimeComponent(hours) + ":";
    }

    markTime += padTimeComponent(minutes) + ":" + padTimeComponent(seconds) + ")";

    return markTime;
}

function padTimeComponent(component) {
    return (component < 10 ? "0" + component : component);
}

// Actual player stuff
var markers = [];
var currentMarker = null;
var speed = 1;
var currentTime = 0;
var lastFrameTime = 0;
var scrollTo = -1;
var playerReady = false;

function onPlayerReady() {
    setTimeout(function() {
        for (var i = 0; i < markers.length; ++i) {
            if (markers[i].endTime === null) {
                markers[i].endTime = player.getDuration();
            }
        }

        updateSize();
    }, 100);
    playerReady = true;
}

function onPlayerStateChange(ev) {
    if (ev.data == 1) {
        playing = true;
        currentTime = player.getCurrentTime();
    } else if (ev.data == 2 || ev.data == 3) {
        playing = false;
        currentTime = player.getCurrentTime();
        setProgress(currentTime);
    } else {
        playing = false;
    }
}

function onPlayerPlaybackRateChange(ev) {
    speed = ev.data;
}

function initVideo() {
    if (youtubePlayerReady) {
        markers = [];
        var markerEls = document.querySelectorAll(".playerContainer .marker");
        for (var i = 0; i < markerEls.length; ++i) {
            var marker = {
                timestamp: parseInt(markerEls[i].getAttribute("data-timestamp")),
                endTime: (i < markerEls.length - 1 ? parseInt(markerEls[i+1].getAttribute("data-timestamp")) : null),
                el: markerEls[i],
                progress: markerEls[i].querySelector(".progress")
            };
            markers.push(marker);
            markerEls[i].addEventListener("click", (function(marker) {
                return function() {
                    if (playerReady) {
                        player.seekTo(marker.timestamp, true);
                        if (!playing) {
                            player.playVideo();
                        }
                    }
                }
            })(marker));
        }
        var playerContainer = document.querySelector(".playerContainer");
        var videoContainer = playerContainer.querySelector(".videoContainer");
        var marksContainer = playerContainer.querySelector(".marksContainer");
        marksContainer.style.height = videoContainer.offsetWidth / 16 * 9;
        player = new YT.Player("player", {
            videoId: annotations.videoId,
            width: videoContainer.offsetWidth,
            height: videoContainer.offsetWidth / 16 * 9,
            events: {
                "onReady": onPlayerReady,
                "onStateChange": onPlayerStateChange,
                "onPlaybackRateChange": onPlayerPlaybackRateChange
            }
        });
        window.addEventListener("resize", function() {
            updateSize();
        });
    }
}

function updateSize() {
    var videoContainer = document.querySelector(".playerContainer .videoContainer");
    var marksContainer = document.querySelector(".playerContainer .marksContainer");
    player.setSize(videoContainer.offsetWidth, videoContainer.offsetWidth / 16 * 9);
    marksContainer.style.height = videoContainer.offsetWidth / 16 * 9;
}

function setProgress(time) {
    var newCurrentMarker = currentMarker;
    for (var i = 0; i < markers.length; ++i) {
        var marker = markers[i];
        if (marker.timestamp <= time && marker.endTime > time) {
            marker.progress.style.width = ((time - marker.timestamp) / (marker.endTime - marker.timestamp)) * 100 + "%";
            if (currentMarker != marker) {
                marker.el.classList.add("current");
                newCurrentMarker = marker;
            }
        }
    }

    if (currentMarker != newCurrentMarker) {
        if (currentMarker) {
            currentMarker.progress.style.width = "0%";
            currentMarker.el.classList.remove("current");
        }
        currentMarker = newCurrentMarker;
        if (currentMarker) {
            scrollTo = currentMarker.el.offsetTop + currentMarker.el.offsetHeight/2.0;
        }
    }
}

function update() {
    var now = performance.now();
    var delta = now - lastFrameTime;
    lastFrameTime = now;
    if (playing) {
        currentTime += delta / 1000.0 * speed;
        setProgress(currentTime);
    }

    if (scrollTo >= 0) {
        var marksContainer = document.querySelector(".playerContainer .marksContainer");
        marksContainer.scrollTop = scrollTo - marksContainer.offsetHeight/2.0;
        scrollTo = -1;
    }

    requestAnimationFrame(update);
}

lastFrameTime = performance.now();
update();

</script>
</body>
</html>
